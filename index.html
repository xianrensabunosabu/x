<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Block Blast Ultimate</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --cell:40px;
  --gap:4px;
  --bg:#fafafa;
  --board:#e5e7eb;
  --empty:#f3f4f6;
  --tile1:#3b82f6;
  --tile2:#60a5fa;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
  display:flex;
  justify-content:center;
}
.game{
  width:360px;
  padding:12px;
}
h1{text-align:center;margin:6px 0}
.top{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}
.board{
  position:relative;
  display:grid;
  grid-template-columns:repeat(8,var(--cell));
  gap:var(--gap);
  background:var(--board);
  padding:6px;
  border-radius:16px;
}
.cell{
  width:var(--cell);
  height:var(--cell);
  background:var(--empty);
  border-radius:8px;
}
.cell.filled{
  background:linear-gradient(135deg,var(--tile1),var(--tile2));
}
.blocks{
  display:flex;
  justify-content:space-between;
  margin-top:12px;
}
.block{touch-action:none}
.block-inner{
  display:grid;
  gap:var(--gap);
}
.bcell{
  width:var(--cell);
  height:var(--cell);
  background:linear-gradient(135deg,var(--tile1),var(--tile2));
  border-radius:8px;
}
.hidden{opacity:.3;pointer-events:none}

/* ドロップ演出 */
.drop{
  animation:drop .18s ease-out;
}
@keyframes drop{
  0%{transform:scale(1.15)}
  100%{transform:scale(1)}
}

/* 失敗ブルブル */
.shake{
  animation:shake .3s;
}
@keyframes shake{
  0%,100%{transform:translateX(0)}
  25%{transform:translateX(-6px)}
  75%{transform:translateX(6px)}
}
</style>
</head>

<body>

<div class="game">
  <h1>Block Blast</h1>
  <div class="top">
    <div>Score <span id="score">0</span></div>
    <div>Best <span id="best">0</span></div>
  </div>

  <div class="board" id="board"></div>
  <div class="blocks" id="blocks"></div>
</div>

<script>
/* ===== Audio ===== */
const ctx=new (window.AudioContext||webkitAudioContext)();
function se(freq,dur){
  const o=ctx.createOscillator();
  const g=ctx.createGain();
  o.frequency.value=freq;
  o.connect(g);g.connect(ctx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+dur);
  o.stop(ctx.currentTime+dur);
}

/* ===== Game State ===== */
const SIZE=8;
const CELL=40+4;
let board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
let score=0;

const scoreEl=document.getElementById("score");
const bestEl=document.getElementById("best");
bestEl.textContent=localStorage.getItem("bb_best")||0;

const boardEl=document.getElementById("board");
const blocksEl=document.getElementById("blocks");

const SHAPES=[
 [[1,1,1]],
 [[1],[1],[1]],
 [[1,1],[1,1]],
 [[1,1,1],[0,1,0]],
 [[1,0],[1,1],[0,1]]
];

/* ===== Draw ===== */
function drawBoard(){
  boardEl.innerHTML="";
  board.flat().forEach(v=>{
    const c=document.createElement("div");
    c.className="cell"+(v?" filled":"");
    boardEl.appendChild(c);
  });
}

function randShape(){
  return SHAPES[Math.floor(Math.random()*SHAPES.length)];
}

function drawBlocks(){
  blocksEl.innerHTML="";
  for(let i=0;i<3;i++){
    const shape=randShape();
    const b=document.createElement("div");
    b.className="block";
    const inner=document.createElement("div");
    inner.className="block-inner";
    inner.style.gridTemplateColumns=`repeat(${shape[0].length},var(--cell))`;
    shape.flat().forEach(v=>{
      const c=document.createElement("div");
      c.className="bcell";
      if(!v)c.style.visibility="hidden";
      inner.appendChild(c);
    });
    b.appendChild(inner);
    enableDrag(b,shape);
    blocksEl.appendChild(b);
  }
}

/* ===== Drag & Snap ===== */
function enableDrag(el,shape){
  let offsetX=0, offsetY=0, dragging=false;

  el.addEventListener("pointerdown",e=>{
    const r=el.getBoundingClientRect();
    offsetX=e.clientX-r.left;
    offsetY=e.clientY-r.top;

    el.style.position="fixed";
    el.style.left=r.left+"px";
    el.style.top=r.top+"px";
    el.style.zIndex=999;

    dragging=true;
    el.setPointerCapture(e.pointerId);
  });

  el.addEventListener("pointermove",e=>{
    if(!dragging)return;
    el.style.left=(e.clientX-offsetX)+"px";
    el.style.top =(e.clientY-offsetY)+"px";
  });

  el.addEventListener("pointerup",e=>{
    dragging=false;
    el.releasePointerCapture(e.pointerId);

    if(snapPlace(el,shape)){
      el.classList.add("hidden");
      se(600,.08);
    }else{
      navigator.vibrate?.(120);
      se(120,.15);
      el.classList.add("shake");
      setTimeout(()=>el.classList.remove("shake"),300);
      el.style.position="";
      el.style.left="";
      el.style.top="";
      el.style.zIndex="";
    }
  });
}

/* ===== Snap Logic ===== */
function snapPlace(el,shape){
  const br=boardEl.getBoundingClientRect();
  const er=el.getBoundingClientRect();

  const cx=er.left+er.width/2;
  const cy=er.top +er.height/2;

  let gx=Math.round((cx-br.left)/(CELL));
  let gy=Math.round((cy-br.top )/(CELL));

  if(!canPlace(shape,gx,gy))return false;

  shape.forEach((row,sy)=>row.forEach((v,sx)=>{
    if(v)board[gy+sy][gx+sx]=1;
  }));

  score+=shape.flat().filter(v=>v).length;
  clearLines();
  update();

  drawBoard();
  // ドロップ演出
  setTimeout(()=>{
    document.querySelectorAll(".cell.filled").forEach(c=>{
      c.classList.add("drop");
      setTimeout(()=>c.classList.remove("drop"),180);
    });
  },0);

  return true;
}

function canPlace(shape,x,y){
  for(let sy=0;sy<shape.length;sy++)
    for(let sx=0;sx<shape[0].length;sx++)
      if(shape[sy][sx]){
        if(y+sy>=SIZE||x+sx>=SIZE||board[y+sy][x+sx])return false;
      }
  return true;
}

/* ===== Clear ===== */
function clearLines(){
  for(let y=0;y<SIZE;y++)
    if(board[y].every(v=>v)){
      board[y].fill(0);
      score+=10;
    }
  for(let x=0;x<SIZE;x++)
    if(board.every(r=>r[x])){
      for(let y=0;y<SIZE;y++)board[y][x]=0;
      score+=10;
    }
}

function update(){
  scoreEl.textContent=score;
  if(score>bestEl.textContent){
    bestEl.textContent=score;
    localStorage.setItem("bb_best",score);
  }
}

/* ===== Init ===== */
drawBoard();
drawBlocks();
</script>
</body>
</html>
