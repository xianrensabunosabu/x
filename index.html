<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Block Blast Ultimate</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --cell:40px;
  --gap:4px;
  --bg:#f8fafc;
  --board:#dbeafe;
  --empty:#eff6ff;
  --tile1:#60a5fa;
  --tile2:#93c5fd;
}
[data-theme="original"]{
  --bg:#fafafa;
  --board:#e5e7eb;
  --empty:#f3f4f6;
  --tile1:#3b82f6;
  --tile2:#60a5fa;
}
[data-theme="dark"]{
  --bg:#0f172a;
  --board:#020617;
  --empty:#1e293b;
  --tile1:#38bdf8;
  --tile2:#0ea5e9;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
  display:flex;
  justify-content:center;
}
.game{
  width:360px;
  padding:12px;
}
h1{text-align:center;margin:6px 0}
.top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}
.board{
  display:grid;
  grid-template-columns:repeat(8,var(--cell));
  gap:var(--gap);
  background:var(--board);
  padding:6px;
  border-radius:16px;
}
.cell{
  width:var(--cell);
  height:var(--cell);
  background:var(--empty);
  border-radius:8px;
}
.cell.filled{
  background:linear-gradient(135deg,var(--tile1),var(--tile2));
}
.blocks{
  display:flex;
  justify-content:space-between;
  margin-top:12px;
}
.block{touch-action:none}
.block-inner{
  display:grid;
  gap:var(--gap);
}
.bcell{
  width:var(--cell);
  height:var(--cell);
  background:linear-gradient(135deg,var(--tile1),var(--tile2));
  border-radius:8px;
}
.hidden{opacity:.3;pointer-events:none}
.flash{
  position:fixed;
  inset:0;
  background:white;
  opacity:0;
  pointer-events:none;
}
.flash.active{
  animation:flash .4s;
}
@keyframes flash{
  0%{opacity:0}
  40%{opacity:1}
  100%{opacity:0}
}
.center-text{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:32px;
  font-weight:bold;
  pointer-events:none;
  opacity:0;
}
.center-text.show{
  animation:poptext .8s;
}
@keyframes poptext{
  0%{transform:scale(.5);opacity:0}
  40%{transform:scale(1.2);opacity:1}
  100%{transform:scale(1);opacity:0}
}
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
}
.popup{
  background:white;
  padding:20px;
  border-radius:16px;
  text-align:center;
}
button{
  padding:8px 14px;
  border:none;
  border-radius:999px;
  background:#3b82f6;
  color:white;
  margin-top:10px;
}
</style>
</head>

<body data-theme="original">

<div class="game">
  <h1>Block Blast</h1>

  <div class="top">
    <div>Score <span id="score">0</span><br>Best <span id="best">0</span></div>
    <select onchange="setTheme(this.value)">
      <option value="original">本家</option>
      <option value="pop">ポップ</option>
      <option value="dark">ダーク</option>
    </select>
  </div>

  <div class="board" id="board"></div>
  <div class="blocks" id="blocks"></div>
</div>

<div class="flash" id="flash"></div>
<div class="center-text" id="centerText">PERFECT!</div>

<div class="overlay" id="gameover">
  <div class="popup">
    <div>Game Over</div>
    <div>Score <span id="final"></span></div>
    <button onclick="restart()">再プレイ</button>
  </div>
</div>

<script>
/* ===== Audio ===== */
const ctx=new (window.AudioContext||webkitAudioContext)();
function se(freq,dur){
 const o=ctx.createOscillator();
 const g=ctx.createGain();
 o.frequency.value=freq;
 o.connect(g);g.connect(ctx.destination);
 o.start();
 g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+dur);
 o.stop(ctx.currentTime+dur);
}

/* ===== Game ===== */
const SIZE=8;
let board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
let score=0,combo=0;
const bestEl=document.getElementById("best");
bestEl.textContent=localStorage.getItem("bb_best")||0;

const SHAPES=[
 [[1,1,1]],
 [[1],[1],[1]],
 [[1,1],[1,1]],
 [[1,1,1],[0,1,0]]
];

const boardEl=document.getElementById("board");
const blocksEl=document.getElementById("blocks");

function drawBoard(){
 boardEl.innerHTML="";
 board.flat().forEach(v=>{
  const c=document.createElement("div");
  c.className="cell"+(v?" filled":"");
  boardEl.appendChild(c);
 });
}

function randShape(){
 return SHAPES[Math.floor(Math.random()*SHAPES.length)];
}

function drawBlocks(){
 blocksEl.innerHTML="";
 for(let i=0;i<3;i++){
  const s=randShape();
  const b=document.createElement("div");
  b.className="block";
  const inn=document.createElement("div");
  inn.className="block-inner";
  inn.style.gridTemplateColumns=`repeat(${s[0].length},var(--cell))`;
  s.flat().forEach(v=>{
   const c=document.createElement("div");
   c.className="bcell";
   if(!v)c.style.visibility="hidden";
   inn.appendChild(c);
  });
  b.appendChild(inn);
  enableDrag(b,s);
  blocksEl.appendChild(b);
 }
}

function enableDrag(el,shape){
 let ox,oy,drag=false;
 el.onpointerdown=e=>{
  drag=true;ox=e.clientX;oy=e.clientY;
  el.setPointerCapture(e.pointerId);
 };
 el.onpointermove=e=>{
  if(!drag)return;
  el.style.position="fixed";
  el.style.left=e.clientX-ox+el.offsetLeft+"px";
  el.style.top=e.clientY-oy+el.offsetTop+"px";
 };
 el.onpointerup=()=>{
  drag=false;
  if(place(el,shape)){
   el.classList.add("hidden");
   se(600,.08);
  }else{
   navigator.vibrate?.(120);
   se(120,.15);
   el.style="";
  }
 };
}

function place(el,shape){
 const r=boardEl.getBoundingClientRect();
 const x=Math.round((el.getBoundingClientRect().left-r.left)/44);
 const y=Math.round((el.getBoundingClientRect().top-r.top)/44);
 if(!can(shape,x,y))return false;
 shape.forEach((row,sy)=>row.forEach((v,sx)=>{
  if(v)board[y+sy][x+sx]=1;
 }));
 score+=shape.flat().filter(v=>v).length;
 clearLines();
 update();
 return true;
}

function can(s,x,y){
 for(let sy=0;sy<s.length;sy++)
  for(let sx=0;sx<s[0].length;sx++)
   if(s[sy][sx]){
    if(y+sy>=SIZE||x+sx>=SIZE||board[y+sy][x+sx])return false;
   }
 return true;
}

function clearLines(){
 let cleared=0;
 for(let y=0;y<SIZE;y++)
  if(board[y].every(v=>v)){board[y].fill(0);cleared++}
 for(let x=0;x<SIZE;x++)
  if(board.every(r=>r[x])){
   for(let y=0;y<SIZE;y++)board[y][x]=0;
   cleared++;
  }
 if(cleared){
  combo++;
  score+=cleared*10*combo;
  se(800+combo*80,.12);
  if(cleared>=2)perfect();
 }else combo=0;
}

function perfect(){
 document.getElementById("flash").classList.add("active");
 document.getElementById("centerText").classList.add("show");
 se(1200,.25);
 setTimeout(()=>{
  flash.classList.remove("active");
  centerText.classList.remove("show");
 },500);
}

function update(){
 drawBoard();
 scoreEl.textContent=score;
 if(score>bestEl.textContent){
  bestEl.textContent=score;
  localStorage.setItem("bb_best",score);
 }
}

function setTheme(t){
 document.body.dataset.theme=t;
}

function restart(){
 board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
 score=0;combo=0;
 drawBoard();drawBlocks();update();
 document.getElementById("gameover").style.display="none";
}

drawBoard();
drawBlocks();
</script>
</body>
</html>
